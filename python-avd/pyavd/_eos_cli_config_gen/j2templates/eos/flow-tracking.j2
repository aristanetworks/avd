{#
 Copyright (c) 2023-2024 Arista Networks, Inc.
 Use of this source code is governed by the Apache License 2.0
 that can be found in the LICENSE file.
#}
{# eos - flow trackings #}
{# hardware #}
{% if flow_tracking.hardware is arista.avd.defined %}
!
flow tracking hardware
{%     for tracker in flow_tracking.hardware.trackers | arista.avd.natural_sort %}
{%         if not loop.first %}
   !
{%         endif %}
   tracker {{ tracker.name }}
{%         if tracker.record_export.on_inactive_timeout is arista.avd.defined %}
      record export on inactive timeout {{ tracker.record_export.on_inactive_timeout }}
{%         endif %}
{%         if tracker.record_export.on_interval is arista.avd.defined %}
      record export on interval {{ tracker.record_export.on_interval }}
{%         endif %}
{%         if tracker.record_export.mpls is arista.avd.defined(true) %}
      record export mpls
{%         endif %}
{%         for exporter in tracker.exporters | arista.avd.natural_sort("name") %}
{%             if not loop.first %}
      !
{%             endif %}
      exporter {{ exporter.name }}
{%             if exporter.collector.host is arista.avd.defined %}
{%                 set collector_cli = 'collector ' ~ exporter.collector.host %}
{%                 if exporter.collector.port is arista.avd.defined %}
{%                     set collector_cli = collector_cli ~ ' port ' ~ exporter.collector.port %}
{%                 endif %}
         {{ collector_cli }}
{%             endif %}
{%             if exporter.format.ipfix_version is arista.avd.defined %}
         format ipfix version {{ exporter.format.ipfix_version }}
{%             endif %}
{%             if exporter.local_interface is arista.avd.defined %}
         local interface {{ exporter.local_interface }}
{%             endif %}
{%             if exporter.template_interval is arista.avd.defined %}
         template interval {{ exporter.template_interval }}
{%             endif %}
{%         endfor %}
{%         if tracker.table_size is arista.avd.defined %}
      flow table size {{ tracker.table_size }} entries
{%         endif %}
{%     endfor %}
{%     if flow_tracking.hardware.record.format_ipfix_standard_timestamps_counters is arista.avd.defined(true) %}
   record format ipfix standard timestamps counters
{%     endif %}
{%     if flow_tracking.hardware.shutdown is arista.avd.defined(false) %}
   no shutdown
{%     endif %}
{% endif %}
{# sampled #}
{% if flow_tracking.sampled is arista.avd.defined %}
!
flow tracking sampled
{%     if flow_tracking.sampled.encapsulation is arista.avd.defined %}
{%         set encapsulation = "encapsulation" %}
{%         if flow_tracking.sampled.encapsulation.ipv4_ipv6 is arista.avd.defined(true) %}
{%             set  encapsulation =  encapsulation ~ ' ipv4 ipv6' %}
{%             if flow_tracking.sampled.encapsulation.mpls is arista.avd.defined(true) %}
{%                 set  encapsulation =  encapsulation ~ ' mpls' %}
{%             endif %}
{%         endif %}
   {{ encapsulation }}
{%     endif %}
{%     if flow_tracking.sampled.sample is arista.avd.defined %}
   sample {{ flow_tracking.sampled.sample }}
{%     endif %}
{%     if flow_tracking.sampled.hardware_offload is arista.avd.defined %}
{%         set hardware_offload_protocols = [] %}
{%         if flow_tracking.sampled.hardware_offload.ipv4 is arista.avd.defined(true) %}
{%             do hardware_offload_protocols.append('ipv4') %}
{%         endif %}
{%         if flow_tracking.sampled.hardware_offload.ipv6 is arista.avd.defined(true) %}
{%             do hardware_offload_protocols.append('ipv6') %}
{%         endif %}
{%         if hardware_offload_protocols | length > 0 %}
   hardware offload {{ hardware_offload_protocols | join(' ') }}
{%         endif %}
{%         if flow_tracking.sampled.hardware_offload.threshold_minimum is arista.avd.defined %}
   hardware offload threshold minimum {{ flow_tracking.sampled.hardware_offload.threshold_minimum }} samples
{%         endif %}
{%     endif %}
{%     for tracker in flow_tracking.sampled.trackers | arista.avd.natural_sort %}
{%         if not loop.first %}
   !
{%         endif %}
   tracker {{ tracker.name }}
{%         if tracker.table_size is arista.avd.defined %}
      flow table size {{ tracker.table_size }} entries
{%         endif %}
{%         if tracker.record_export.on_inactive_timeout is arista.avd.defined %}
      record export on inactive timeout {{ tracker.record_export.on_inactive_timeout }}
{%         endif %}
{%         if tracker.record_export.on_interval is arista.avd.defined %}
      record export on interval {{ tracker.record_export.on_interval }}
{%         endif %}
{%         if tracker.record_export.mpls is arista.avd.defined(true) %}
      record export mpls
{%         endif %}
{%         for exporter in tracker.exporters | arista.avd.natural_sort("name") %}
{%             if not loop.first %}
      !
{%             endif %}
      exporter {{ exporter.name }}
{%             if exporter.collector.host is arista.avd.defined %}
{%                 set collector_cli = 'collector ' ~ exporter.collector.host %}
{%                 if exporter.collector.port is arista.avd.defined %}
{%                     set collector_cli = collector_cli ~ ' port ' ~ exporter.collector.port %}
{%                 endif %}
         {{ collector_cli }}
{%             endif %}
{%             if exporter.format.ipfix_version is arista.avd.defined %}
         format ipfix version {{ exporter.format.ipfix_version }}
{%             endif %}
{%             if exporter.local_interface is arista.avd.defined %}
         local interface {{ exporter.local_interface }}
{%             endif %}
{%             if exporter.template_interval is arista.avd.defined %}
         template interval {{ exporter.template_interval }}
{%             endif %}
{%         endfor %}
{%     endfor %}
{%     if flow_tracking.sampled.shutdown is arista.avd.defined(false) %}
   no shutdown
{%     endif %}
{% endif %}
