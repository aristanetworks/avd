{# j2lint: disable=V1 #}
router_bgp:

{% if switch.evpn_role == "server" or switch.mpls_overlay_role == "server" %}
  bgp_cluster_id: {{ switch.bgp_cluster_id | arista.avd.default(switch.router_id) }}
{% endif %}

  peer_groups:
    {{ overlay_data.overlay_peer_group_name }}:
{% if switch.mpls_overlay_role in ["server", "client"] %}
      type: mpls
{% else %}
      type: evpn
{% endif %}
      update_source: Loopback0
      remote_as: "{{ switch.bgp_as }}"
      bfd: true
{% if switch.mpls_overlay_role in ["server", "client"] %}
{%     if bgp_peer_groups.MPLS_OVERLAY_PEERS.password is arista.avd.defined() %}
      password: "{{ bgp_peer_groups.MPLS_OVERLAY_PEERS.password }}"
{%     endif %}
{% else %}
{%     if bgp_peer_groups.EVPN_OVERLAY_PEERS.password is arista.avd.defined() %}
      password: "{{ bgp_peer_groups.EVPN_OVERLAY_PEERS.password }}"
{%     endif %}
{% endif %}
      send_community: all
      maximum_routes: 0
{% if switch.evpn_role == "server" or switch.mpls_overlay_role == "server" %}
      route_reflector_client: true
{% endif %}
{% if switch.mpls_overlay_role == "server" and overlay_data.mpls_rr_peers is arista.avd.defined %}
    {{ overlay_data.rr_peers_peer_group_name }}:
      type: mpls
      update_source: Loopback0
      remote_as: "{{ bgp_as }}"
      bfd: true
{%     if bgp_peer_groups.RR_OVERLAY_PEERS.password is arista.avd.defined() %}
      password: "{{ bgp_peer_groups.RR_OVERLAY_PEERS.password }}"
      send_community: all
      maximum_routes: 0
{%     endif %}
{% endif %}

  address_family_ipv4:
    peer_groups:
      {{ overlay_data.overlay_peer_group_name }}:
        activate: false
{% if switch.mpls_overlay_role == "server" and overlay_data.mpls_rr_peers is arista.avd.defined %}
      {{ overlay_data.rr_peers_peer_group_name }}:
        activate: false
{% endif %}

  address_family_evpn:
{% if switch.mpls_overlay_role in ["server", "client"] %}
    neighbor_default:
      encapsulation: mpls
{%     if switch.mpls_overlay_role == "client" %}
      next_hop_self_source_interface: Loopback0
{%     endif %}
{% endif %}
    peer_groups:
      {{ overlay_data.overlay_peer_group_name }}:
        activate: true
{% if switch.vtep_ip is arista.avd.defined %}
        route_map_in: RM-EVPN-SOO-IN
        route_map_out: RM-EVPN-SOO-OUT
{% endif %}
{% if switch.mpls_overlay_role == "server" and overlay_data.mpls_rr_peers is arista.avd.defined %}
      {{ overlay_data.rr_peers_peer_group_name }}:
        activate: true
{% endif %}
{% if switch.vtep_ip is arista.avd.defined and evpn_hostflap_detection is arista.avd.defined %}
    evpn_hostflap_detection:
      window: {{ evpn_hostflap_detection.window | arista.avd.default(180) }}
      threshold: {{ evpn_hostflap_detection.threshold | arista.avd.default(5) }}
      enabled: {{ evpn_hostflap_detection.enabled | arista.avd.default(true) }}
{% endif %}
{% if switch.vtep_ip is arista.avd.defined and evpn_import_pruning is arista.avd.defined(true) %}
    route:
      import_match_failure_action: discard
{% endif %}
{% if switch.mpls_overlay_role in ["server", "client"] %}
  address_family_vpn_ipv4:
{%     if switch.mpls_overlay_role == "client" %}
    neighbor_default_encapsulation_mpls_next_hop_self:
      source_interface: Loopback0
{%     endif %}
    peer_groups:
      {{ overlay_data.overlay_peer_group_name }}:
        activate: true
{%     if switch.mpls_overlay_role == "server" and overlay_data.mpls_rr_peers is arista.avd.defined %}
      {{ overlay_data.rr_peers_peer_group_name }}:
        activate: true
{%     endif %}
  address_family_vpn_ipv6:
{%     if switch.mpls_overlay_role == "client" %}
    neighbor_default_encapsulation_mpls_next_hop_self:
      source_interface: Loopback0
{%     endif %}
    peer_groups:
      {{ overlay_data.overlay_peer_group_name }}:
        activate: true
{%     if switch.mpls_overlay_role == "server" and overlay_data.mpls_rr_peers is arista.avd.defined %}
      {{ overlay_data.rr_peers_peer_group_name }}:
        activate: true
{%     endif %}
{% endif %}
{% if evpn_overlay_bgp_rtc is arista.avd.defined(true) %}
  address_family_rtc:
    peer_groups:
      {{ overlay_data.overlay_peer_group_name }}:
        activate: true
{%     if switch.evpn_role == "server" or switch.mpls_overlay_role == "server" %}
        default_route_target:
          only: true
{%     endif %}
{% endif %}

{# Overlay network peering #}
  neighbors:
{% if switch.mpls_overlay_role in ["server", "client"] %}
{%     for mpls_route_server in overlay_data.mpls_route_servers | arista.avd.natural_sort %}
    {{ overlay_data.mpls_route_servers[mpls_route_server].ip_address }}:
      peer_group: {{ overlay_data.overlay_peer_group_name }}
      description: {{ mpls_route_server }}
{%     endfor %}
{%     for mpls_route_client in overlay_data.mpls_route_clients | arista.avd.natural_sort %}
    {{ overlay_data.mpls_route_clients[mpls_route_client].ip_address }}:
      peer_group: {{ overlay_data.overlay_peer_group_name }}
      description: {{ mpls_route_client }}
{%     endfor %}
{%     if overlay_data.mpls_mesh_pes is arista.avd.defined %}
{%         for mpls_mesh_pe in overlay_data.mpls_mesh_pes | arista.avd.natural_sort %}
    {{ overlay_data.mpls_mesh_pes[mpls_mesh_pe].ip_address }}:
      peer_group: {{ overlay_data.overlay_peer_group_name }}
      description: {{ mpls_mesh_pe }}
{%         endfor %}
{%     endif %}
{%     if switch.mpls_overlay_role == "server" and overlay_data.mpls_rr_peers is arista.avd.defined %}
{%         for mpls_rr_peer in overlay_data.mpls_rr_peers | arista.avd.natural_sort %}
    {{ overlay_data.mpls_rr_peers[mpls_rr_peer].ip_address }}:
      peer_group: {{ overlay_data.rr_peers_peer_group_name }}
      description: {{ mpls_rr_peer }}
{%         endfor %}
{%     endif %}
{% else %}
{%     for evpn_route_server in overlay_data.evpn_route_servers | arista.avd.natural_sort %}
    {{ overlay_data.evpn_route_servers[evpn_route_server].ip_address }}:
      peer_group: {{ overlay_data.overlay_peer_group_name }}
      description: {{ evpn_route_server }}
{%     endfor %}
{%     for evpn_route_client in overlay_data.evpn_route_clients | arista.avd.natural_sort %}
    {{ overlay_data.evpn_route_clients[evpn_route_client].ip_address }}:
      peer_group: {{ overlay_data.overlay_peer_group_name }}
      description: {{ evpn_route_client }}
{%     endfor %}
{% endif %}
